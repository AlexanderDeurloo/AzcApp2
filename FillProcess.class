' Gambas class file
PUBLIC InputCount AS Integer = 0
PUBLIC StirCount AS Integer = 0

PUBLIC LastContainer AS Boolean
PUBLIC FillPending AS Boolean
PUBLIC FillDone AS Boolean
PUBLIC SampleTaken AS Boolean
PUBLIC ToStir AS Integer
PUBLIC ProcessReady AS Boolean
PUBLIC StartBowl AS Boolean
PUBLIC BowlInUse AS Boolean
PUBLIC BowlOnSpeed AS Boolean
PUBLIC StirPending AS Boolean
PUBLIC StirDone AS Boolean
PUBLIC FirstRun AS Boolean

PUBLIC BowlStarted AS Boolean


PUBLIC SUB GoForIt()
  SerialHandler.TxRxFast(off.lamp_green)
  InputCount = 0
  StirCount = 0
  LastContainer = FALSE
  FillPending = FALSE
  FillDone = FALSE
  SampleTaken = TRUE
  ToStir = 0
  ProcessReady = FALSE
  StartBowl = FALSE
  BowlInUse = FALSE
  BowlOnSpeed = FALSE
  StirPending = FALSE
  StirDone = FALSE
  FirstRun = TRUE
  BowlStarted = FALSE
  
  ' arm bowl start delay timer.
  TimerBowlStartDelay.Delay = 10 * 1000 ' 10 sec
  TimerBowlStartDelay.Enabled = TRUE
  
  DO
    Fill() 
    WAIT 0.1
    'BowlSpeedUp()
    WAIT 0.1
     Stir()
    WAIT 0.1
    ' Bowl()
    WAIT 0.1
  LOOP UNTIL (LastContainer = TRUE) AND (ToStir = 0)
  SerialHandler.TxRxFast(on.lamp_green)
END

PUBLIC SUB BowlSpeedUp()
  IF BowlStarted = TRUE THEN ' start timer elapsed.
  
  ENDIF 
  IF BowlInUse THEN RETURN 
  ' start up bowl
  BowlInUse = TRUE
  BowlOnSpeed = FALSE
END


PUBLIC SUB Stir()
  IF ToStir = 0 THEN
   PRINT "nothing to stir"
   RETURN 
  ENDIF 
  PRINT "3 something to stir"
  PRINT "stirpending = " & StirPending
  IF StirPending = TRUE THEN 
    IF StirDone = FALSE THEN RETURN 
    'china: use serial control for stirrer:
    Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
    'SerialHandler.TxRxFast(off.stirrer_max)
    IF SampleTaken = FALSE THEN RETURN 
    IF (CleanMachine.Stir_Pending = FALSE) THEN 
      'china: use serial control for stirrer:
      Stirrer.SetRpm(0)    '
      'SerialHandler.TxRxFast(off.stirrer)
    ENDIF 
    'StirPending = FALSE
    'StirDone = FALSE
    'DEC ToStir
    'IF Check.Stirrer_Lift() = "down" THEN 
    '  SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
    '  DO
        IF (FillDone = TRUE) THEN 
          SerialHandler.TxRxFast(off.lamp_orange) ' watervale off
        ENDIF 
     '   WAIT 0.1
      'LOOP UNTIL Check.Stirrer_Lift() = "up"
    'ENDIF 
    'MainAZC.Stirrer_Dirty = FALSE   ' debug temporary.
    CleanMachine.Stir(5)
    RETURN 
  ELSE 
    PRINT " new start stir"
    IF Check.Input_Container_Stir() = "missing" THEN 
      PRINT " error no container at fill"
      RETURN   ' return error !!!
    ENDIF 
    PRINT " dirty = " 
    PRINT MainAZC.Stirrer_Dirty
    
    IF (MainAZC.Stirrer_Dirty = TRUE) THEN 
      ' clean stirrer
      'CleanMachine.Stir(5)

      RETURN 
    ENDIF 
    ' move to container
    PRINT "move stir"
    IF Check.Stirrer_Rotate() = "clean" THEN 
      IF Check.Stirrer_Lift() = "down" THEN 
        SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
        DO
          FillProcess.CheckFill() 
          WAIT 0.2
        LOOP UNTIL Check.Stirrer_Lift() = "up"
      ENDIF 
      SerialHandler.TxRxFast(on.stirrer_rotate)
      DO
        FillProcess.CheckFill() 
        WAIT 0.2
      LOOP UNTIL Check.Stirrer_Rotate() = "stir"
    ENDIF
    IF (Check.Stirrer_Lift() = "up") THEN 
      SerialHandler.TxRxFast(off.stirrer_lift) ' lift down
      DO
        FillProcess.CheckFill() 
        WAIT 0.2
      LOOP UNTIL Check.Stirrer_Lift() = "down"
    ENDIF 

    INC StirCount
    'SerialHandler.TxRxFast(on.stirrer) 'china: do not switch it !!
    'china: use serial control for stirrer:
    Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_High_Speed, MainAZC.Var_Ini]))    '
    'SerialHandler.TxRxFast(on.stirrer_max)
    StirPending = TRUE
    StirDone = FALSE
    MainAZC.Stirrer_Dirty = TRUE
    TimerStir.Delay = 4000  'ms
    TimerStir.Enabled = TRUE
    RETURN 
  ENDIF 
  
END

PUBLIC SUB Bowl()
  
  
  
END


PUBLIC SUB Fill()
  IF LastContainer THEN
   PRINT " last container reached"
   IF (InputCount = StirCount) AND (StirPending = FALSE) THEN ToStir = 0
   RETURN 
  ENDIF 
  IF FillPending THEN 
    IF (FillDone = FALSE) THEN
     PRINT "."
     WAIT 0.5
     RETURN 
    ENDIF 
    WAIT 0.1
    SerialHandler.TxRxFast(off.lamp_orange)  ' debug
    WAIT 0.5
    IF StirPending = TRUE THEN RETURN 
    IF SampleTaken = FALSE THEN
     PRINT ","
     
     RETURN 
    ENDIF 
    
    
'    IF InputCount = 8 THEN 
    IF InputCount = Val(MainAZC.Var_Array[MainAZC.Max_Input_Containers, MainAZC.Var_Ini]) THEN 'china
      LastContainer = 1
    ELSE 
      ' move input
      Search.Next_Input() ' to do: what is case of ....? is this full proof?
    ENDIF 
    INC ToStir
    FillDone = FALSE
    FillPending = FALSE
  ELSE 
    IF Check.Input_Container_Fill() = "missing" THEN 
      LastContainer = 1
      PRINT "no Container anymore"
      RETURN 
    ELSE 
      INC InputCount
      FillPending = TRUE
      ' cmd to plc
      SerialHandler.TxRxFast(on.lamp_orange)
      PRINT "1 start fill by plc"
      FillDone = FALSE
      ' load timer
      TimerFill.Delay = 4000
      StartBowl = TRUE
      TimerFill.Enabled = TRUE
      RETURN 
    ENDIF 
  ENDIF 
  RETURN
END


PUBLIC SUB TimerFill_Timer()
  TimerFill.Enabled = FALSE
  FillDone = TRUE
  'PRINT "2 fill done"
END

PUBLIC SUB TimerStir_Timer()

  StirDone = TRUE
  TimerStir.Enabled = FALSE
  'PRINT "stir done time"
    

END

PUBLIC SUB CheckFill()
   IF (FillDone = TRUE) THEN 
      SerialHandler.TxRxFast(off.lamp_orange) ' watervale off
   ENDIF 
END

PUBLIC SUB TimerBowlStartDelay_Timer()
  TimerBowlStartDelay.Enabled = FALSE
  BowlStarted = TRUE
END
