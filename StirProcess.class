' Gambas class file

PUBLIC SUB Fill_Stir_Setup() AS String  'china: seems to be unused !!
  DIM Errors AS String = ""
  DIM reply AS String = ""
  reply = Search.Output_Container()
  IF reply <> "Found" THEN Errors = "ERR97"
  reply = Search.Input_Container()
  IF reply <> "Found" THEN Errors = "ERR97"
  IF Errors <> "" THEN GOTO finish
  ' check if container is full yet, so n0 fill required:
  IF Check.Water_Level = "true" THEN 
    ' skip water fill
  ELSE 
    ' fill container : send command to PLC, which handles the entire process.
  ENDIF 
  ' poll water level until "true"
  ' what about starting the stirrer already?
finish:
  RETURN Errors
END


PUBLIC SUB MoveStir(position AS String)
  IF position = "clean" THEN 
    IF Check.Stirrer_Rotate() = "stir" THEN 
      IF Check.Stirrer_Lift() = "down" THEN 
        SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
        DO
          WAIT 0.1
        LOOP UNTIL Check.Stirrer_Lift() = "up"
      ENDIF 
      WAIT 1
      SerialHandler.TxRxFast(off.stirrer_rotate)
      DO
        WAIT 0.1
      LOOP UNTIL Check.Stirrer_Rotate() = "clean"
    ENDIF
    IF Check.Stirrer_Lift() = "up" THEN 
      SerialHandler.TxRxFast(off.stirrer_lift) ' lift down
      DO
        WAIT 0.1
      LOOP UNTIL Check.Stirrer_Lift() = "down"
    ENDIF 
  ELSE IF position = "stir" THEN 
    IF Check.Stirrer_Rotate() = "clean" THEN 
      IF Check.Stirrer_Lift() = "down" THEN 
        SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
        DO
          FillProcess.CheckFill() 
          WAIT 0.2
        LOOP UNTIL Check.Stirrer_Lift() = "up"
      ENDIF 
      SerialHandler.TxRxFast(on.stirrer_rotate)
      DO
        FillProcess.CheckFill() 
        WAIT 0.2
      LOOP UNTIL Check.Stirrer_Rotate() = "stir"
    ENDIF
    IF (Check.Stirrer_Lift() = "up") THEN 
      SerialHandler.TxRxFast(off.stirrer_lift) ' lift down
      DO
        FillProcess.CheckFill() 
        WAIT 0.2
      LOOP UNTIL Check.Stirrer_Lift() = "down"
    ENDIF 
  ENDIF
  RETURN 
END


PUBLIC SUB MoveStirCleanFilter()
  IF Check.Stirrer_Lift() = "down" THEN 
    SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
    DO
      WAIT 0.2
    LOOP UNTIL Check.Stirrer_Lift() = "up"
  ENDIF 
  SerialHandler.TxRxFast(on.stirrer_rotate) 'rotate to stir position
  DO
    FillProcess.CheckFill() 
    WAIT 0.2
  LOOP UNTIL Check.Stirrer_Rotate() = "stir"
  RETURN 
END

