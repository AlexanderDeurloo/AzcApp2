' Gambas class file
PUBLIC RXdata AS String
PUBLIC RXdataPending AS String
PUBLIC TimeOut AS Boolean
PUBLIC DumpS AS String

PUBLIC SUB Open_Serial(NamePort AS String) AS Integer
  DIM retry AS Integer
  WAIT 1  ' required. 0.1 works also.
  PRINT NamePort  
  PRINT "about TO OPEN port " & NamePort
  Sport.PortName = NamePort   'china
  WAIT 0.2
  IF Sport.Status = Net.inActive THEN
  'Sport.PortName = "/dev/ttyS0"  ' china
    Sport.Speed = 9600
    Sport.DataBits = 8
    Sport.StopBits = 1

    DO
      TRY 
        Sport.Open()
      IF ERROR THEN 
        PRINT "retry " & retry & " of 100 opening " & Sport.PortName 
        IF retry > 2 THEN MainAZC.StatusText("Retry " & retry & " of 100 opening " & Sport.PortName)
      ELSE 
        PRINT "Successful opened " & Sport.PortName
        IF retry > 2 THEN MainAZC.StatusText(Sport.PortName & " opened successful.")
        BREAK 
      ENDIF 
      WAIT 2
      INC retry
    LOOP UNTIL retry = 100
    
    
    WAIT 2
    DumpS = TxRxFast("\n")
    IF DumpS = "ERR98" THEN 
      RETURN 2  ' no reply from PLC
    ELSE
      RETURN 1  ' plc replied
    ENDIF 
  ELSE
    RETURN 0    ' serial port not available
  ENDIF 
END

PUBLIC SUB Transmit(TXdata AS String)
  IF Sport.Status = Net.Inactive THEN
    RXdataPending = "ERR99"  ' indicates that the serial port is not opened.
  ELSE
    RXdataPending = ""
    RXdata = ""
    PRINT #Sport, (TXdata & Chr$(13));
  END IF
END

PUBLIC SUB SPort_Read()
  DIM Answer AS String
  READ #Sport, Answer, Lof(Sport) 
  IF Answer = Chr$(13) THEN 
  RXdata = RXdataPending
  RXdataPending = ""
 ELSE  
  RXdataPending = RXdataPending & Answer
 ENDIF
END

PUBLIC SUB Serial_Close()
  IF Sport.Status = Net.Active THEN CLOSE Sport
END

PUBLIC SUB TxRx(TX AS String) AS String
  DIM Reply AS String
  Transmit(TX)
  WAIT 0.5     ' 0.02 is minimum
  SPort_Read()
  Reply = Left$(RXdataPending, 5)
  IF Reply = NULL THEN 
    reply = "ERR98"   ' indicates that there was no reply.
  ENDIF 
  RETURN Reply
END


PUBLIC SUB TxRxFast(TX AS String) AS String
  DIM reply AS String = ""
  WAIT 0.02
  Transmit(TX)
  WAIT 0.02
  TimeOut = FALSE
  TimerOutSerial.Delay = 5000 ' 5 seconds
  TimerOutSerial.Enabled = TRUE
  DO 
    SPort_Read()
    WAIT 0.001
    reply = reply & RXdataPending
  LOOP UNTIL (InStr(reply, Chr$(13)) > 0) OR TimeOut = TRUE
  reply = Left$(reply, 5) 
  IF reply = NULL THEN 
  reply = "ERR98"   'indicates that there was no reply.
  ENDIF 
  TimerOutSerial.Enabled = FALSE
  RETURN reply
END

PUBLIC SUB TxRxTimed(TX AS String, MaxTime AS Integer) AS String
  DIM reply AS String = ""
  WAIT 0.02
  Transmit(TX)
  WAIT 0.02
  IF (MaxTime < 1000) THEN MaxTime = 1000
  TimeOut = FALSE
  TimerOutSerial.Delay = MaxTime
  TimerOutSerial.Enabled = TRUE
  DO 
    SPort_Read()
    WAIT 0.001
    reply = reply & RXdataPending
  LOOP UNTIL (InStr(reply, Chr$(13)) > 0) OR TimeOut = TRUE
  reply = Left$(reply, 5) 
  IF reply = NULL THEN 
  reply = "ERR98"   'indicates that there was no reply.
  ENDIF 
  TimerOutSerial.Enabled = FALSE
  RETURN reply
END


PUBLIC SUB TimerOutSerial_Timer()
  TimerOutSerial.Enabled = FALSE
  TimeOut = TRUE
  MainAZC.NoGo = TRUE
  PRINT " time out !!"
END
