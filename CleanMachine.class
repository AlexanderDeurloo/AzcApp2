' Gambas class file
PUBLIC Kaoline_Clean_Pending AS Boolean = FALSE
PUBLIC Bowl_Clean_Pending AS Boolean = FALSE
PUBLIC Tube_Clean_Pending AS Boolean = FALSE

PUBLIC Stir_Clean_Pending AS Boolean = FALSE
PUBLIC Stir_Clean_Setup AS Boolean = FALSE

PUBLIC SUB All(skipbowl AS Boolean)
  IF (Stir_Clean_Setup = TRUE) THEN ' stir cleaning is not stopped yet
  PRINT " stir is bezig"
  DO
    WAIT 0.1
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Stir_Stop_Check() = "done"   ' check until stirrer clean is done.
  ENDIF 
  PRINT "nu de bowl dan"
  WAIT 0.5
  IF skipbowl = FALSE THEN Bowl_Setup()
finish:
END


PUBLIC SUB Stir(cleanTime AS Integer) ' cleantime in seconds
  PRINT "cleantime = " & cleanTime
  IF Stir_Clean_Setup = FALSE THEN 
    MainAZC.Stirrer_Dirty = TRUE
    MainAZC.update_leds()
    Stir_Clean_Pending = TRUE
    Stirrer_Setup(cleanTime)
    Stir_Clean_Setup = TRUE
    RETURN 
  ENDIF
  WAIT 0.1 
  PRINT "stir clean pending = " & Stir_Clean_Pending
  IF (Stir_Clean_Pending = FALSE) THEN 
    Stirrer_Stop()  ' close all valves
    Stir_Clean_Setup = FALSE
    Stir_Clean_Pending = FALSE
    MainAZC.Stirrer_Dirty = FALSE
    MainAZC.update_leds()
    RETURN 
  ENDIF 
  RETURN 
END


PUBLIC SUB Stirrer_Setup(cleanTime AS Integer)
  ' check position
  IF Check.Stirrer_Rotate() = "stir" THEN 
    IF Check.Stirrer_Lift() = "down" THEN 
      SerialHandler.TxRxFast(on.stirrer_lift) ' lift up
      DO
        FillProcess.CheckFill() 
        WAIT 0.1
      LOOP UNTIL Check.Stirrer_Lift() = "up"
    ENDIF 
    SerialHandler.TxRxFast(off.stirrer_rotate)
    DO
        FillProcess.CheckFill() 
        WAIT 0.1
    LOOP UNTIL Check.Stirrer_Rotate() = "clean"
  ENDIF
  IF Check.Stirrer_Lift() = "up" THEN 
    SerialHandler.TxRxFast(off.stirrer_lift) ' lift down
    DO
        FillProcess.CheckFill() 
        WAIT 0.1
    LOOP UNTIL Check.Stirrer_Lift() = "down"
  ENDIF 
  'china: use serial control for stirrer:
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
  ' stirrer is on position now.
  'SerialHandler.TxRxFast(off.stirrer_max)       ' stir slow speed
  'WAIT 0.1
  'SerialHandler.TxRxFast(on.stirrer)            ' stir on

  WAIT 0.1
  SerialHandler.TxRxFast(on.water_valve_clean)  ' water in clean centre
  WAIT 0.1
  SerialHandler.TxRxFast(on.sample_valve)       ' sample tube
  WAIT 0.1
  SerialHandler.TxRxFast(on.water_valve_tube)   ' clean tube with water
  TimerStirClean.Enabled = FALSE
  TimerStirClean.Delay = cleanTime 'ms
  TimerStirClean.Enabled = TRUE
  PRINT "timer stir started..." & CStr(cleanTime) & "msec"
  RETURN 
END

PUBLIC SUB TimerStirClean_Timer()
  TimerStirClean.Enabled = FALSE
  Stir_Clean_Pending = FALSE
  PRINT "stir cleaN TIMER END"
END


PUBLIC SUB Stirrer_Stop()
  SerialHandler.TxRxFast(off.water_valve_tube)
  WAIT 0.1
  SerialHandler.TxRxFast(off.sample_valve)  
  WAIT 0.1
  SerialHandler.TxRxFast(off.water_valve_clean)
  WAIT 0.1
  'SerialHandler.TxRxFast(off.stirrer)
  Stirrer.SetRpm(0)  'china: use serial control for stirrer
  WAIT 0.1
END

PUBLIC SUB Stir_Stop_Check() AS String
  IF (Stir_Clean_Pending = FALSE) AND (Stir_Clean_Setup = TRUE) THEN    ' to check is time expired + to avoid restart cleaning
    Stir(0)  ' STOPS STIR CLEANING
    PRINT "clean is fini"
    RETURN "done"
  ENDIF 
  RETURN "busy"
END










PUBLIC SUB Bowl_Setup()
  MainAZC.Bowl_Dirty = TRUE
  Bowl_Clean_Pending = TRUE
  MainAZC.update_leds()
  PRINT "bowl clean"

  PRINT "wait for stir to complete"
  DO
    WAIT 0.1
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL (Stir_Clean_Pending = FALSE)
  PRINT "stir is ready, bowl can continue"
  PRINT "freq1 off"
  PRINT SerialHandler.TxRxFast(off.freq_1)  ' safety
  PRINT "freq 2 off"
  PRINT SerialHandler.TxRxFast(off.freq_2)  ' safety
  PRINT "wait until bowl stopped(simple timer)"
  DO
    WAIT 0.1
    PRINT ","
  LOOP UNTIL ProcessCTRL.Bowl_Stopped = TRUE  ' wait for bowl to stop. This way we make sure that the tiny motor can be attached.
  
  PRINT "make output store position is off"
  IF Check.Output_Store_Move() = "on" THEN 
    SerialHandler.TxRxFast(off.output_store_move)
    DO
     WAIT 0.1
    LOOP UNTIL Check.Output_Store_Move() = "off"
  ENDIF 

  PRINT "make drain_bowl position off (which should be under bowl)"  'china: move it under bowl
  IF Check.Drain_Bowl_Position() = "on" THEN 
    SerialHandler.TxRxFast(off.drain_bowl)
    DO
     WAIT 0.1
    LOOP UNTIL Check.Drain_Bowl_Position() = "off"
  ENDIF 

  ' wait for stir clean.
  PRINT "bowl ls"
  ' bowl slow speed
  IF MainAZC.StopProcess = 1 THEN GOTO finish
  PRINT SerialHandler.TxRxFast(on.bowl_low_speed)
  WAIT 0.5
  ' kaoline clean moment
  PRINT "clean kaoline tube"
  SerialHandler.TxRxFast(on.kaoline_valve)  ' open kaoline valve.
  Kaoline_Clean_Pending = TRUE
  TimerKaolineClean.Delay = TimeTable.Kaoline_Valve_Clean_Time
  TimerKaolineClean.Enabled = TRUE
  SerialHandler.TxRxFast(on.water_valve_tube)      ' push kaoline back with clean water
  DO
    WAIT 0.001
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Kaoline_Clean_Pending = FALSE    ' wait for kaoline time.
  SerialHandler.TxRxFast(off.water_valve_tube)
  SerialHandler.TxRxFast(off.kaoline_valve)
  WAIT 1
  PRINT " do the bowl clean procedure"
  Tube_Clean_Pending = TRUE
  SerialHandler.TxRxFast(on.water_valve_tube)
  SerialHandler.TxRxFast(on.pump_tube)  
  TimerCleanTube.Delay = TimeTable.Tube_Clean
  TimerCleanTube.Enabled = TRUE
  DO
    WAIT 0.01
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Tube_Clean_Pending = FALSE
  SerialHandler.TxRxFast(off.water_valve_tube)
  SerialHandler.TxRxFast(off.pump_tube)

  WAIT 0.5
  SerialHandler.TxRxFast(on.water_valve_HP)
  WAIT 1
  SerialHandler.TxRxFast(on.high_pressure)
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase1_Time 'ms
  TimerBowlClean.Enabled = TRUE
  PRINT "timer bowl phase1 started..." & CStr(TimeTable.Bowl_Clean_Phase1_Time) & "msec"
  DO
    WAIT 0.1
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Bowl_Clean_Pending = FALSE
  SerialHandler.TxRxFast(off.high_pressure)
  'SerialHandler.TxRxFast(off.water_valve_HP) ' new: to allow buffer to fill
  Bowl_Clean_Pending = TRUE
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase2_Time 'ms
  TimerBowlClean.Enabled = TRUE
  PRINT "timer bowl phase2 started..." & CStr(TimeTable.Bowl_Clean_Phase2_Time) & "msec"
  DO
    WAIT 0.1
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Bowl_Clean_Pending = FALSE
  
  SerialHandler.TxRxFast(on.water_valve_HP)
  SerialHandler.TxRxFast(on.high_pressure)
  Bowl_Clean_Pending = TRUE
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase3_Time 'ms
  TimerBowlClean.Enabled = TRUE
  PRINT "timer bowl phase3 started..." & CStr(TimeTable.Bowl_Clean_Phase3_Time) & "msec"
  DO
    WAIT 0.1
    IF MainAZC.StopProcess = 1 THEN GOTO finish
  LOOP UNTIL Bowl_Clean_Pending = FALSE
   
  Bowl_Stop()
  MainAZC.Bowl_Dirty = FALSE  
  MainAZC.update_leds()
finish:
  RETURN 
END




PUBLIC SUB Bowl_Stop()
  SerialHandler.TxRxFast(off.high_pressure)  
  WAIT 0.2
  'SerialHandler.TxRxFast(off.water_valve_HP) ' new: allow buffer to fill
  WAIT 0.2
  SerialHandler.TxRxFast(off.bowl_low_speed)
  PRINT "bowl is clean and all related ctrls are off"
  RETURN 
END

PUBLIC SUB TimerKaolineClean_Timer()
  TimerKaolineClean.Enabled = FALSE
  PRINT "kaoline tube clean time expired"
  Kaoline_Clean_Pending = FALSE
  RETURN 
END

PUBLIC SUB TimerBowlClean_Timer()
  TimerBowlClean.Enabled = FALSE
  PRINT "bowl clean timer expired"
  Bowl_Clean_Pending = FALSE
END


PUBLIC SUB TimerCleanTube_Timer()
  TimerCleanTube.Enabled = FALSE
  Tube_Clean_Pending = FALSE
END

PUBLIC SUB STOP_TIMERS()
  TimerBowlClean.Enabled = FALSE
  TimerCleanTube.Enabled = FALSE
  TimerKaolineClean.Enabled = FALSE
  TimerStirClean.Enabled = FALSE  
END

