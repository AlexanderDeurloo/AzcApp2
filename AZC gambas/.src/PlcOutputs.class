' Gambas class file

Library "~/AzcSystem/Libraries/RevPi/libpiControlIf"

Extern piControlWrite(Offset As Integer, Length As Integer, Setting As Pointer)

Public Mod30Addr70Data As Integer = 0
Public Mod30Addr71Data As Integer = 0
Public Mod31Addr183Data As Integer = 0
Public Mod31Addr184Data As Integer = 0
Public RevPiAddr232Data As Integer = 0  ' internal of revpi. to control leds and relay.

Public Sub Shutdown(State As String)
  ' perhaps the internal relay of the revpi is turned on after powerup.
  'piControlWrite(ModuleAddress, 1, VarPtr(DataA))
  If State = "on"
    Set("ShutdownIndicator", 1) ' relay open
  Else
    Set("ShutdownIndicator", 0) ' relay closed
  Endif
End


Public Sub Set(Pin As String, State As Integer)
  
  Dim DataA As Integer
  Dim ModuleAddress As Integer
  Dim PinAddr As Integer
  
  ' figure out which pin:
  If Pin = "AirStirrerLiftRotateForward"
    ModuleAddress = 70     ' 70 = mod30, first 8 pins
    PinAddr = 1
  Else If Pin = "AirStirrerLiftRotateBackward"
    ModuleAddress = 70
    PinAddr = 2
  Else If Pin = "AirStirrerLiftUp"
    ModuleAddress = 70
    PinAddr = 4
  Else If Pin = "AirStirrerLiftDown"
    ModuleAddress = 70
    PinAddr = 8
  Else If Pin = "AirOutputMoveForward"
    ModuleAddress = 70
    PinAddr = 16
  Else If Pin = "AirOutputMoveBackward"
    ModuleAddress = 70
    PinAddr = 32
  Else If Pin = "AirOutputRotateOn"
    ModuleAddress = 70
    PinAddr = 64
  Else If Pin = "AirOutputRotateOff"
    ModuleAddress = 70
    PinAddr = 128
  Else If Pin = "AirBowlDrainForward"
    ModuleAddress = 71         ' 71 = mod30, last 6 pins
    PinAddr = 1
  Else If Pin = "AirBowlDrainBackward"
    ModuleAddress = 71
    PinAddr = 2
  Else If Pin = "AirTubeValveSample"
    ModuleAddress = 71
    PinAddr = 4
  Else If Pin = "AirTubeValveMagnesium"
    ModuleAddress = 71
    PinAddr = 8
  Else If Pin = "AirTubeValveKaoline"
    ModuleAddress = 71
    PinAddr = 16
  Else If Pin = "AirBowlCooling"
    ModuleAddress = 71
    PinAddr = 32
  Else If Pin = "TubePumpPower"
    ModuleAddress = 183     ' 183 = mod31, first 8 pins
    PinAddr = 1
  Else If Pin = "StirrerPower"
    ModuleAddress = 183
    PinAddr = 2
  Else If Pin = "WaterValveStirrerClean"
    ModuleAddress = 183
    PinAddr = 4
  Else If Pin = "WaterValveTubes"
    ModuleAddress = 183
    PinAddr = 8
  Else If Pin = "WaterValveHpPump"
    ModuleAddress = 183
    PinAddr = 16
  Else If Pin = "InputMotor"
    ModuleAddress = 183
    PinAddr = 32
  Else If Pin = "HpPumpPower"
    ModuleAddress = 183
    PinAddr = 64
  Else If Pin = "KaolineMotorPower"
    ModuleAddress = 183
    PinAddr = 128
  Else If Pin = "OutputSensorTeach"
    ModuleAddress = 184     ' 184 = mod31, last 6 pins
    PinAddr = 1
  Else If Pin = "Spare1"
    ModuleAddress = 184
    PinAddr = 2
  Else If Pin = "Spare2"
    ModuleAddress = 184
    PinAddr = 4
  Else If Pin = "Spare3"
    ModuleAddress = 184
    PinAddr = 8
  Else If Pin = "Spare4"
    ModuleAddress = 184
    PinAddr = 16
  Else If Pin = "UsbHub"
    ModuleAddress = 184
    PinAddr = 32
  Else If Pin = "ShutdownIndicator"
    ModuleAddress = 232
    PinAddr = 64
  Else
    Print "no valid input in PlcOutput.Set: " & Pin 
    Return
  Endif
  'Print "moduleaddr: " & ModuleAddress & " pinadd " & PinAddr
  ' update setting:
  If State = 1
    If ModuleAddress = 70
      Mod30Addr70Data = Mod30Addr70Data Or PinAddr
      DataA = Mod30Addr70Data
    Else If ModuleAddress = 71
      Mod30Addr71Data = Mod30Addr71Data Or PinAddr
      DataA = Mod30Addr71Data
    Else If ModuleAddress = 183
      Mod31Addr183Data = Mod31Addr183Data Or PinAddr
      DataA = Mod31Addr183Data
    Else If ModuleAddress = 184
      Mod31Addr184Data = Mod31Addr184Data Or PinAddr
      DataA = Mod31Addr184Data
    Else If ModuleAddress = 232
      RevPiAddr232Data = RevPiAddr232Data Or PinAddr
      DataA = RevPiAddr232Data
    Else
      Print "internal error in function PlcOutputs.Set"
      Return
    Endif
  Else
    If ModuleAddress = 70
      Mod30Addr70Data = Mod30Addr70Data And (Not PinAddr)
      DataA = Mod30Addr70Data
    Else If ModuleAddress = 71
      Mod30Addr71Data = Mod30Addr71Data And (Not PinAddr)
      DataA = Mod30Addr71Data
    Else If ModuleAddress = 183
      Mod31Addr183Data = Mod31Addr183Data And (Not PinAddr)
      DataA = Mod31Addr183Data
    Else If ModuleAddress = 184
      Mod31Addr184Data = Mod31Addr184Data And (Not PinAddr)
      DataA = Mod31Addr184Data
    Else If ModuleAddress = 232
      RevPiAddr232Data = RevPiAddr232Data And (Not PinAddr)
      DataA = RevPiAddr232Data
    Else
      Print "internal error in function PlcOutputs.Set"
      Return
    Endif
  Endif
  'Print "moduleaddr: " & ModuleAddress & " DataA " & DataA
  
  'send:
  piControlWrite(ModuleAddress, 1, VarPtr(DataA))
  Return
End


Public Sub StirrerLift(NewPosition As String) As Integer
  If MainAZC.StopProcess = 1 Then Goto finish
  While PlcInputs.Read("InputCoverClosed") = "0"
    If MainAZC.StopProcess = 1 Then Goto finish
    Message.Title = "Attention"
    Message.Warning("Please close Input Cover")
    Wait 1
  Wend
  If Comp(NewPosition, "up") == 0
    PlcOutputs.Set("AirStirrerLiftDown", 0)
    PlcOutputs.Set("AirStirrerLiftUp", 1)
  Else If Comp(NewPosition, "down") == 0
    PlcOutputs.Set("AirStirrerLiftUp", 0)
    PlcOutputs.Set("AirStirrerLiftDown", 1)
  Else
    Print "Invalid option in PlcOutput.StirrerLift :" & NewPosition
    Return 1
  Endif
finish:
  Return 0
End


Public Sub StirrerRotate(NewPosition As String) As Integer
  If Comp(NewPosition, "stir") == 0
    PlcOutputs.Set("AirStirrerLiftRotateBackward", 0)
    PlcOutputs.Set("AirStirrerLiftRotateForward", 1)
  Else If Comp(NewPosition, "clean") == 0
    PlcOutputs.Set("AirStirrerLiftRotateForward", 0)
    PlcOutputs.Set("AirStirrerLiftRotateBackward", 1)
  Else
    Print "Invalid option in PlcOutput.StirrerRotate :" & NewPosition
    Return 1
  Endif
  Return 0
End



Public Sub OutputStoreMove(NewPosition As String) As Integer
  If Comp(NewPosition, "capture") == 0
    PlcOutputs.Set("AirOutputMoveBackward", 0)
    PlcOutputs.Set("AirOutputMoveForward", 1)
  Else If Comp(NewPosition, "rest") == 0
    PlcOutputs.Set("AirOutputMoveForward", 0)
    PlcOutputs.Set("AirOutputMoveBackward", 1)
  Else
    Print "Invalid option in PlcOutput.OutputStoreMove :" & NewPosition
    Return 1
  Endif
  Return 0
End

Public Sub OutputStoreRotate(NewPosition As String) As Integer
  If Comp(NewPosition, "on") == 0
    PlcOutputs.Set("AirOutputRotateOff", 0)
    PlcOutputs.Set("AirOutputRotateOn", 1)
  Else If Comp(NewPosition, "off") == 0
    PlcOutputs.Set("AirOutputRotateOn", 0)
    PlcOutputs.Set("AirOutputRotateOff", 1)
  Else
    Print "Invalid option in PlcOutput.OutputStoreRotate :" & NewPosition
    Return 1
  Endif
  Return 0
End



Public Sub BowlDrain(NewPosition As String) As Integer
  If Comp(NewPosition, "underbowl") == 0
    PlcOutputs.Set("AirBowlDrainBackward", 0)
    PlcOutputs.Set("AirBowlDrainForward", 1)
  Else If Comp(NewPosition, "awayfrombowl") == 0
    PlcOutputs.Set("AirBowlDrainForward", 0)
    PlcOutputs.Set("AirBowlDrainBackward", 1)
  Else
    Print "Invalid option in PlcOutput.BowlDrain :" & NewPosition
    Return 1
  Endif
  Return 0
End

Public Sub TubePump(State As String)
  If State = "on"
    Set("TubePumpPower", 1)
    If PlcInputs.Read("TubePumpOpen") = 1
      Message.Title = "Attention"
      Message.Error("Tubepump isn't running. Not closed?")
    Endif
  Else
    Set("TubePumpPower", 0)
  Endif
End


