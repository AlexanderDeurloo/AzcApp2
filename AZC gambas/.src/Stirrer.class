' Gambas class file

Library "~/AzcSystem/Libraries/Serial/libStirrer"

Extern Stirrer_Open(Devicename As String) As Integer
Extern Stirrer_Close() As Integer
Extern SendRpm(RpmSetting As Integer) As Integer


Public Sub OpenComm(Dev As String) As Integer
  Print "Let's open the Stirrer communication: " & Dev
  Stirrer_Open(Dev)
  Return 0
End


Public Sub CloseComm() As Integer
  Stirrer_Close()
  Print "Stirrer communication closed."
  Return 0
End


Public Sub SetRpm(RpmSet As Integer) As Integer
  Dim ReturnCode As Integer
  Dim Device As String
  Dim Retry As Integer
  Device = MainAZC.Var_Array[MainAZC.CommPortStirrer, MainAZC.Var_Ini]
  
  Stirrer_Open(Device)
  Wait 0.1
  ReturnCode = SendRpm(RpmSet)
  Print "Stirrer speed set to " & RpmSet & " rpm."
  Print "Returncode stirrer lib = " & ReturnCode
  If (ReturnCode < 0) 
    For Retry = 0 To 5
      Print "Stirrer SetRpm: error found !!!!"
      Wait 2
      Stirrer_Close()
      Print "Try to fix..."
      Wait 2
      Stirrer_Open(Device)
      Wait 1
      ReturnCode = SendRpm(RpmSet)
      Print "Stirrer speed set again to " & RpmSet & " rpm."
      Print "Returncode stirrer lib during retry = " & ReturnCode
      If (ReturnCode >= 0) 
        Print "We fixed the stirrer comm. Retries = " & Retry
        ' should be okay again
        Break
       Endif
    Next
  Endif
  Stirrer_Close()
  Return 0
End

