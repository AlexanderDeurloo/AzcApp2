' Gambas class file

Public Input_Container As Boolean = True    ' debug to avoid placing containers everytime
Public Stir_Ready As Boolean
Public Bowl_On_Speed As Boolean
Public Magn_Done As Boolean
Public Water_Done As Boolean
Public Sample_Done As Boolean
Public Kaoline_Done As Boolean
Public Centrifuge_Done As Boolean
Public Capture_Done As Boolean
Public Output_Container As Boolean = True   ' debug to avoid placing containers everytime
Public Process_Count As Integer
'PUBLIC timeclean AS Integer = 4
Public Bowl_Stopped As Boolean
Public Startup_clean As Boolean = True
Public Bowl_Delay As Integer
Public Bowl_May_Go As Boolean
Public Bowl_Running As Boolean


Public Sub Go()
  Stir_Ready = False
  Bowl_On_Speed = False
  Bowl_Stopped = True
  Bowl_Running = False
  Magn_Done = False
  Water_Done = False
  Sample_Done = False
  Kaoline_Done = False
  Centrifuge_Done = False
  Capture_Done = False
  Process_Count = 0
  MainAZC.Fill_Time_Table() ' loads all timer settings in variables.
  Print "let's look for clean at power-on: " & MainAZC.Clean_Every_Startup_Flag
  If MainAZC.Stirrer_Dirty = True Then
    Print "hela, Stirrer is dirty"
    MainAZC.StatusText("Cleaning Stirrer before use...")
    'SerialCpuComm.TxRxFast("red", 1)
    CleanMachine.Stir_Clean_Setup = False
    CleanMachine.Stir(TimeTable.Stirrer_Clean_Time)
    MainAZC.update_leds()
    If MainAZC.Bowl_Dirty = False Then
      CleanMachine.All(True)
    Endif
  Endif
  If MainAZC.StopProcess = 1 Then Goto finish
  If MainAZC.Bowl_Dirty = True Then
    Print "hela, bowl is dirty"
    MainAZC.StatusText("Cleaning Bowl before use...")
    'SerialCpuComm.TxRxFast("red", 1)
    Bowl_Stopped = True
    CleanMachine.All(False)
  Endif
  
  MainAZC.update_leds()
  Startup_clean = False   ' to avoid recleaning every hit of "play"
  SerialCpuComm.TxRxFast("green", 1)

  If MainAZC.StopProcess = 1 Then Goto finish
  Bowl_Delay = TimeTable.Stir_Time - TimeTable.Motor_ACC
  If Bowl_Delay < 1000 Then
    Bowl_Delay = 5  ' 5 ms
  Else
    Bowl_Delay += 100
  Endif

  
  Do
    MainAZC.CTRL_Progress_Timer(True) ' start progress bar)
    MainAZC.StatusText("Running...")
    If Fill_Input() Then
      Message.Title = "Attention"
      Message.Error("Water fill timeout. Check main water pressure.", "Stop")
      Wait 1
     Goto finish
    Endif
    If MainAZC.StopProcess = 1 Then Goto finish
    Rotate_Input()
    If MainAZC.StopProcess = 1 Then Goto finish
    Start_Stir()
    MainAZC.Stirrer_Dirty = True
    MainAZC.update_leds()
    Bowl_May_Go = False
    If MainAZC.StopProcess = 1 Then Goto finish
    Start_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Stir()
    If MainAZC.StopProcess = 1 Then Goto finish
    Stir_Slow()
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Bowl_Speedup()
    If MainAZC.StopProcess = 1 Then Goto finish
    MainAZC.Bowl_Dirty = True
    MainAZC.update_leds()
    If MainAZC.StopProcess = 1 Then Goto finish
    Fill_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Stop_Stir()             ' stop Stirrer, move to clean and starts cleaning.
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Centrifuge()   ' also checks for stir clean stop
    If MainAZC.StopProcess = 1 Then Goto finish
    Move_Output("capture")
    If MainAZC.StopProcess = 1 Then Goto finish
    Stop_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Print "Bowl stopped. Wait for capture..."
    Wait_For_Capture()      ' also checks for stir clean stop
    If MainAZC.StopProcess = 1 Then Goto finish
    Move_Output("rest")
    If MainAZC.StopProcess = 1 Then Goto finish
    Rotate_Output()
    If MainAZC.StopProcess = 1 Then Goto finish
    Inc Process_Count
    MainAZC.Increment_Counter(Process_Count)
    Print "Debug: starttime = " & MainAZC.starttime
    MainAZC.Time_Correction = Timer() - MainAZC.starttime
    Print "Debug: correction = " & MainAZC.Time_Correction 
    MainAZC.StatusText("Cleaning...")
    CleanMachine.All(False)
    If MainAZC.StopProcess = 1 Then Goto finish
    MainAZC.CTRL_Progress_Timer(False)  ' stop progress bar
    MainAZC.overalltime = MainAZC.Time_Correction
    Print "corrected = " & MainAZC.overalltime
    
    
'  LOOP UNTIL (Input_Container = FALSE) OR (Output_Container = FALSE) OR (Process_Count = 8)
  Loop Until (Input_Container = False) Or (Output_Container = False) Or (Process_Count = Val(MainAZC.Var_Array[MainAZC.Max_Input_Containers, MainAZC.Var_Ini])) 'china
finish:
  Return
End


Public Sub Fill_Input() As Integer ' TODO: to be expanded with timeout capture and action. Now it can be an infinite loop in case of a defect somewhere.
  Dim returncode As Integer
  returncode = 1
  
  SerialCpuComm.TxRxFast("waterfillstop", 1)
  Print "before fill: " & Check.Fill_Status()
  If PlcInputs.Read("InputCoverClosed") = "0"
    Message.Title = "Attention"
    Message.Warning("Please close Input Cover")
    Wait 2
  Endif

  SerialCpuComm.TxRxFast("waterfillstart", 1)
  Print "fill started: " & Check.Fill_Status()
  Wait 0.5
  MainAZC.StatusText("Applying water to input container...")
  Do
    Wait 1
    If MainAZC.StopProcess = 1 Then Goto finish
    Print "during fill: " & Check.Fill_Status()
    
    If PlcInputs.Read("InputCoverClosed") = "0"
      SerialCpuComm.TxRxFast("waterfillstop", 1)
      Message.Title = "Attention"
      Message.Warning("Please close Input Cover")
      Wait 2
      If PlcInputs.Read("InputCoverClosed") = "1"
        SerialCpuComm.TxRxFast("waterfillstart", 1)
      Endif
    Endif
  
    If (Check.Fill_Status() = "timeout") Then
      Print "water fill timeout."
      Goto finish
    Endif
  Loop Until Check.Fill_Status() = "done"
  returncode = 0
finish:
  SerialCpuComm.TxRxFast("waterfillstop", 1) ' just for safety
  MainAZC.StatusText("Water fill done.")
  Wait 2  ' allow last drops to fall.
  Return returncode
End

Public Sub Rotate_Input()
  Input_Container = False
  Search.Next_Input() ' TODO: check return code
  If Check.Input_Container_Fill() = "present" Then Input_Container = True
End

Public Sub Start_Stir()
  Do
    Wait 0.1
  Loop Until MainAZC.Stirrer_Dirty = False
  MainAZC.StatusText("Move stirrer and start it...")
  TimerStir.Delay = TimeTable.Stir_Time '3000  'debug
  StirProcess.MoveStir("stir")
  'use serial control for Stirrer:
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_High_Speed, MainAZC.Var_Ini]))    '
  Stir_Ready = False
  TimerStir.Enabled = True
End

Public Sub Start_Bowl()
  TimerBowlStartDelay.Delay = Bowl_Delay
  TimerBowlStartDelay.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_May_Go = True
  MainAZC.StatusText("Start up bowl...")
  
 
  TimerBowlSpeedup.Delay = TimeTable.Motor_ACC ' 10000
  FreqCtrl.SetFreq(78.75, "ON")
  ' TODO: link setting to time in file and visa versa perhaps
  Bowl_Running = True
  Bowl_On_Speed = False
  TimerBowlSpeedup.Enabled = True
finish:
End

Public Sub Wait_For_Stir()
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Stir_Ready = True
finish:
End

Public Sub Stir_Slow()
  'use serial control for Stirrer:
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
  Wait 2  ' debug
End

Public Sub Wait_For_Bowl_Speedup()
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_On_Speed = True
finish:
End

Public Sub Fill_Bowl()
  ' fill magn (no pump required)
  MainAZC.StatusText("Fill bowl...")
  Magn_Done = False
  PlcOutputs.Set("AirTubeValveMagnesium", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Magnesium() = "on"
  Wait 0.2
  PlcOutputs.TubePump("on")
  TimerMagn.Delay = TimeTable.Magnesium_Fill_Time ' 3000  ' debug
  TimerMagn.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Magn_Done = True
  PlcOutputs.TubePump("off")
  Wait 0.5  'china
  PlcOutputs.Set("AirTubeValveMagnesium", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Magnesium() = "off"
  Wait 0.2
  ' fill water (pump required)
  Water_Done = False
  PlcOutputs.Set("WaterValveTubes", 1)
  PlcOutputs.TubePump("on")
  TimerWater.delay = TimeTable.Bowl_Water_Fill_Time '5000  ' debug
  TimerWater.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Water_Done = True
  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.TubePump("off")
  Wait 1
  ' fill sample
  Sample_Done = False
  PlcOutputs.Set("AirTubeValveSample", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Sample() = "on"
  PlcOutputs.TubePump("on")
  TimerSample.Delay = TimeTable.Sample_Time '10000 ' debug
  TimerSample.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Sample_Done = True
  PlcOutputs.Set("AirTubeValveSample", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Sample() = "off"
  PlcOutputs.TubePump("off")
  Wait 1
  ' fill kaoline
  Kaoline_Done = False
  PlcOutputs.Set("AirTubeValveKaoline", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "on"
  PlcOutputs.TubePump("on")
  TimerKaoline.Delay = TimeTable.Kaoline_Fill_Time '10000 ' debug
  Timerkaoline.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Kaoline_Done = True
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "off"
'extra: clean tube TO BOWL with water:
  PlcOutputs.Set("WaterValveTubes", 1)
  Wait 5
finish:
  PlcOutputs.Set("AirTubeValveMagnesium", 0)
  Do
	   Wait 0.1
  Loop Until Check.TubeValve_Magnesium() = "off"

  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "off"
  PlcOutputs.TubePump("off")
  PlcOutputs.Set("AirTubeValveSample", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Sample() = "off"
  Wait 0.5
End

Public Sub Stop_Stir()
  'use serial control for Stirrer:
  MainAZC.StatusText("Stop stirrer and move to clean centre...")
  Stirrer.SetRpm(0)    '
  StirProcess.MoveStir("clean")
  CleanMachine.Stir(TimeTable.Stirrer_Clean_Time)
  MainAZC.update_leds()
End

Public Sub Wait_For_Centrifuge()
  ' load timer
  Centrifuge_Done = False
  TimerCentrifuge.Delay = TimeTable.Centrifuge_Time ' 4000  ' debug
  TimerCentrifuge.Enabled = True
  ' wait until expired
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
    CleanMachine.stir_stop_check()
  Loop Until Centrifuge_Done = True
finish:
End



Public Sub Move_Output(position As String)
  If position = "capture" Then
    MainAZC.StatusText("Move output store to capture position...")
    Print "Move drain away from bowl. Current position = " & Check.Drain_Bowl_Position() 
    PlcOutputs.BowlDrain("awayfrombowl")
    Print "Move store to capture. Current position = " & Check.Output_Store_Move() 
    PlcOutputs.OutputStoreMove("capture")

    Print "Wait for drain to be removed..."
    Do
      Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "off"
    Print "Drain removed. Wait for store to arrive at capture..."
    Do
      Wait 0.1
    Loop Until Check.Output_Store_Move() = "off"
    Print "Output store arrived at capture."
  Else If position = "rest" Then
    MainAZC.StatusText("Move output store away...")
    Print "Move to rest. Current position = " & Check.Output_Store_Move() 
    PlcOutputs.OutputStoreMove("rest")
    'move drain back under bowl:
    Print "Move drain under bowl. Current position = " & Check.Drain_Bowl_Position() 
    PlcOutputs.BowlDrain("underbowl")
    Print "Wait for drain to arrive under bowl..."
    Do
      Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "on"
    Print "Drain arrived under bowl. Wait for store to arrive at rest..."
    Do
      Wait 0.1
    Loop Until Check.Output_Store_Move() = "on"
    Print "Output store arrived at rest."


  Endif
  Wait 1  ' psyco wait.
End



Public Sub Stop_Bowl()
  MainAZC.StatusText("Stop bowl...")
  FreqCtrl.SetFreq(0.0, "OFF")
  ' TODO: read freq controller via RS485 for actual status
  Bowl_Stopped = False
  TimerBowlSlowDown.delay = TimeTable.Motor_DEC ' 20000 ' debug. time is equal to "DEC" parameter in freq inverters.
  Print "Set timer to wait for motor DEC to " & TimeTable.Motor_DEC
  TimerBowlSlowDown.Enabled = True
End

Public Sub Wait_For_Capture()
  Print "We arrived at wait_for_capture"
  Capture_Done = False
  TimerCapture.Delay = TimeTable.Output_Capture_Time
  Print "Time for capturing is set is " & TimeTable.Output_Capture_Time
  TimerCapture.Enabled = True
  MainAZC.StatusText("capturing result...")
  CleanMachine.StirSpinInit()
  Do
    Wait 1
    'MainAZC.StatusText("capturing result..." & TimerCapture.Delay)
    CleanMachine.stir_stop_check()
    CleanMachine.StirSpinDry()
    
  Loop Until Capture_Done = True
  MainAZC.StatusText("capturing result done.")
End

Public Sub Rotate_Output()
  Output_Container = False
  Search.Next_Output()
  If Check.Output_Container() = "present" Then Output_Container = True
End

Public Sub Stop_All()
  Print " knock all down"
  SerialCpuComm.TxRxFast("red", 1)
  SyncMachine.Controls_To_Default()
  
  If Bowl_Running = True
    TimerBowlSlowDown.Enabled = False
    TimerBowlSlowDown.delay = TimeTable.Motor_DEC 'time is equal to "DEC" parameter in freq inverters.
    TimerBowlSlowDown.Enabled = True
    Bowl_Stopped = False
  Endif
  Do
     Wait 0.1
  Loop Until Bowl_Stopped = True
End

Public Sub TimerStir_Timer()
  TimerStir.Enabled = False
  Stir_Ready = True
End

Public Sub TimerBowlSpeedup_Timer()
  TimerBowlSpeedup.Enabled = False
  Bowl_On_Speed = True
End

Public Sub TimerMagn_Timer()
  TimerMagn.Enabled = False
  Magn_Done = True
End

Public Sub TimerWater_Timer()
  TimerWater.Enabled = False
  Water_Done = True
End

Public Sub TimerSample_Timer()
  TimerSample.Enabled = False
  Sample_Done = True
End

Public Sub TimerKaoline_Timer()
  TimerKaoline.Enabled = False
  Kaoline_Done = True
End

Public Sub TimerCentrifuge_Timer()
  TimerCentrifuge.Enabled = False
  Centrifuge_Done = True
End

Public Sub TimerCapture_Timer()
  TimerCapture.Enabled = False
  Capture_Done = True
End

Public Sub TimerBowlSlowDown_Timer()
  TimerBowlSlowDown.Enabled = False
  Bowl_Stopped = True
  Bowl_Running = False
End

Public Sub TimerBowlStartDelay_Timer()
  TimerBowlStartDelay.Enabled = False
  Bowl_May_Go = True
End

Public Sub STOP_TIMERS()
  TimerBowlSlowDown.Enabled = False
  TimerBowlSpeedup.Enabled = False
  TimerBowlStartDelay.Enabled = False
  TimerCapture.Enabled = False
  TimerCentrifuge.Enabled = False
  TimerKaoline.Enabled = False
  TimerMagn.Enabled = False
  TimerSample.Enabled = False
  TimerStir.Enabled = False
  TimerWater.Enabled = False
End

