' Gambas class file
Public Input_Container As Boolean = True    ' debug to avoid placing containers everytime
Public Stir_Ready As Boolean
Public Bowl_On_Speed As Boolean
Public Magn_Done As Boolean
Public Water_Done As Boolean
Public Sample_Done As Boolean
Public Kaoline_Done As Boolean
Public Centrifuge_Done As Boolean
Public Capture_Done As Boolean
Public Output_Container As Boolean = True   ' debug to avoid placing containers everytime
Public Process_Count As Integer
'PUBLIC timeclean AS Integer = 4
Public Bowl_Stopped As Boolean
Public Startup_clean As Boolean = True
Public Bowl_Delay As Integer
Public Bowl_May_Go As Boolean
Public Bowl_Running As Boolean


Public Sub Go()
  Stir_Ready = False
  Bowl_On_Speed = False
  Bowl_Stopped = True
  Bowl_Running = False
  Magn_Done = False
  Water_Done = False
  Sample_Done = False
  Kaoline_Done = False
  Centrifuge_Done = False
  Capture_Done = False
  Process_Count = 0
  MainAZC.Fill_Time_Table() ' loads all timer settings in variables.
  Print "let's look for clean at power-on: " & MainAZC.Clean_Every_Startup_Flag
  If MainAZC.Stirrer_Dirty = True Then
    Print "hela, stirrer is dirty"
    MainAZC.StatusText("Cleaning Stirrer before use...")
    ' [GB2:KEYW] SerialHandler.TxRxFast(on.lamp_red)
    SerialHandler.TxRxFast({On}.lamp_red)
    CleanMachine.Stir_Clean_Setup = False
    CleanMachine.Stir(TimeTable.Stirrer_Clean_Time)
    MainAZC.update_leds()
    If MainAZC.Bowl_Dirty = False Then
      CleanMachine.All(True)
    Endif
  Endif
  If MainAZC.StopProcess = 1 Then Goto finish
  If MainAZC.Bowl_Dirty = True Then
    Print "hela, bowl is dirty"
    MainAZC.StatusText("Cleaning Bowl before use...")
    ' [GB2:KEYW] SerialHandler.TxRxFast(on.lamp_red)
    SerialHandler.TxRxFast({On}.lamp_red)
    Bowl_Stopped = True
    CleanMachine.All(False)
  Endif
  
  MainAZC.update_leds()
  Startup_clean = False   ' to avoid recleaning every hit of "play"
  SerialHandler.TxRxFast(off.lamp_red)

  If MainAZC.StopProcess = 1 Then Goto finish
  Bowl_Delay = TimeTable.Stir_Time - TimeTable.Motor_ACC
  If Bowl_Delay < 1000 Then
    Bowl_Delay = 5  ' 5 ms
  Else
    Bowl_Delay += 100
  Endif

  
  Do
    MainAZC.CTRL_Progress_Timer(True) ' start progress bar)
    MainAZC.StatusText("Running...")
    If Fill_Input() Then
      Message.Error("Water fill timeout. Check main water pressure.", "Stop")
      Wait 1
     Goto finish
    Endif
    If MainAZC.StopProcess = 1 Then Goto finish
    Rotate_Input()
    If MainAZC.StopProcess = 1 Then Goto finish
    Start_Stir()
    MainAZC.Stirrer_Dirty = True
    MainAZC.update_leds()
    Bowl_May_Go = False
    If MainAZC.StopProcess = 1 Then Goto finish
    Start_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Stir()
    If MainAZC.StopProcess = 1 Then Goto finish
    Stir_Slow()
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Bowl_Speedup()
    If MainAZC.StopProcess = 1 Then Goto finish
    MainAZC.Bowl_Dirty = True
    MainAZC.update_leds()
    If MainAZC.StopProcess = 1 Then Goto finish
    Fill_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Stop_Stir()             ' stop stirrer, move to clean and starts cleaning.
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Centrifuge()   ' also checks for stir clean stop
    If MainAZC.StopProcess = 1 Then Goto finish
    Move_Output("capture")
    If MainAZC.StopProcess = 1 Then Goto finish
    Stop_Bowl()
    If MainAZC.StopProcess = 1 Then Goto finish
    Wait_For_Capture()      ' also checks for stir clean stop
    If MainAZC.StopProcess = 1 Then Goto finish
    Move_Output("rest")
    If MainAZC.StopProcess = 1 Then Goto finish
    Rotate_Output()
    If MainAZC.StopProcess = 1 Then Goto finish
    Inc Process_Count
    MainAZC.Increment_Counter(Process_Count)
    MainAZC.Time_Correction = DateDiff(MainAZC.starttime, Now(), gb.Second)
    MainAZC.StatusText("Cleaning...")
    CleanMachine.All(False)
    If MainAZC.StopProcess = 1 Then Goto finish
    MainAZC.CTRL_Progress_Timer(False)  ' stop progress bar
    MainAZC.overalltime = MainAZC.Time_Correction
    Print "corrected = " & MainAZC.overalltime
    
    
'  LOOP UNTIL (Input_Container = FALSE) OR (Output_Container = FALSE) OR (Process_Count = 8)
  Loop Until (Input_Container = False) Or (Output_Container = False) Or (Process_Count = Val(MainAZC.Var_Array[MainAZC.Max_Input_Containers, MainAZC.Var_Ini])) 'china
finish:
  Return
End


Public Sub Fill_Input() As Integer ' TODO: to be expanded with timeout capture and action. Now it can be an infinite loop in case of a defect somewere.
  Dim returncode As Integer
  returncode = 1
  Print "fill1" & Check.Fill_Status()
  ' [GB2:KEYW] Print SerialHandler.TxRxFast(on.water_valve_fill) ' = "fill"
  Print SerialHandler.TxRxFast({On}.water_valve_fill) ' = "fill"
  Print "fill2" & Check.Fill_Status()
  Wait 0.5
  MainAZC.StatusText("Applying water to input container...")
  Do
    Wait 1
    If MainAZC.StopProcess = 1 Then Goto finish
    Print "fillx" & Check.Fill_Status()
    If (Check.Fill_Status() = "timeout") Then
      Print "water fill timeout."
      Goto finish
    Endif
  Loop Until Check.Fill_Status() = "done"
  returncode = 0
finish:
  SerialHandler.TxRxFast(off.water_valve_fill) ' just for safety
  MainAZC.StatusText("Water fill done.")
  Wait 2  ' allow last drops to fall.
  Return returncode
End

Public Sub Rotate_Input()
  Input_Container = False
  Search.Next_Input()
  If Check.Input_Container_Fill() = "present" Then Input_Container = True
End

Public Sub Start_Stir()
  Do
    Wait 0.1
  Loop Until MainAZC.Stirrer_Dirty = False
  MainAZC.StatusText("Move stirrer and start it...")
  TimerStir.Delay = TimeTable.Stir_Time '3000  'debug
  StirProcess.MoveStir("stir")
  'SerialHandler.TxRxFast(on.stirrer)
  'china: use serial control for stirrer:
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_High_Speed, MainAZC.Var_Ini]))    '
  'SerialHandler.TxRxFast(on.stirrer_max)
  Stir_Ready = False
  TimerStir.Enabled = True
End

Public Sub Start_Bowl()
  TimerBowlStartDelay.Delay = Bowl_Delay
  TimerBowlStartDelay.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_May_Go = True
  MainAZC.StatusText("Start up bowl...")
  
 
  TimerBowlSpeedup.Delay = TimeTable.Motor_ACC ' 10000
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.freq_1)
  SerialHandler.TxRxFast({On}.freq_1)
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.freq_2)
  SerialHandler.TxRxFast({On}.freq_2)
  Bowl_Running = True
  Bowl_On_Speed = False
  TimerBowlSpeedup.Enabled = True
finish:
End

Public Sub Wait_For_Stir()
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Stir_Ready = True
finish:
End

Public Sub Stir_Slow()
  'china: use serial control for stirrer:
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
  'SerialHandler.TxRxFast(off.stirrer_max)
  Wait 2  ' debug
End

Public Sub Wait_For_Bowl_Speedup()
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_On_Speed = True
finish:
End

Public Sub Fill_Bowl()
  ' fill magn (no pump required)
  MainAZC.StatusText("Fill bowl...")
  Magn_Done = False
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.magnesium_valve)
  SerialHandler.TxRxFast({On}.magnesium_valve)
  Wait 0.5  'china
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.pump_magnesium)  'china
  SerialHandler.TxRxFast({On}.pump_magnesium)  'china
  TimerMagn.Delay = TimeTable.Magnesium_Fill_Time ' 3000  ' debug
  TimerMagn.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Magn_Done = True
  SerialHandler.TxRxFast(off.pump_magnesium)  'china
  Wait 0.5  'china
  SerialHandler.TxRxFast(off.magnesium_valve)
  Wait 0.5
  ' fill water (pump required)
  Water_Done = False
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.water_valve_tube)
  SerialHandler.TxRxFast({On}.water_valve_tube)
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.pump_tube)
  SerialHandler.TxRxFast({On}.pump_tube)
  TimerWater.delay = TimeTable.Bowl_Water_Fill_Time '5000  ' debug
  TimerWater.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Water_Done = True
  SerialHandler.TxRxFast(off.water_valve_tube)
  SerialHandler.TxRxFast(off.pump_tube)
  Wait 1
  ' fill sample
  Sample_Done = False
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.sample_valve)
  SerialHandler.TxRxFast({On}.sample_valve)
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.pump_tube)
  SerialHandler.TxRxFast({On}.pump_tube)
  TimerSample.Delay = TimeTable.Sample_Time '10000 ' debug
  TimerSample.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Sample_Done = True
  SerialHandler.TxRxFast(off.sample_valve)
  SerialHandler.TxRxFast(off.pump_tube)
  Wait 1
  ' fill kaoline
  Kaoline_Done = False
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.kaoline_valve)
  SerialHandler.TxRxFast({On}.kaoline_valve)
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.pump_tube)
  SerialHandler.TxRxFast({On}.pump_tube)
  TimerKaoline.Delay = TimeTable.Kaoline_Fill_Time '10000 ' debug
  Timerkaoline.Enabled = True
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Kaoline_Done = True
  SerialHandler.TxRxFast(off.kaoline_valve)
'extra: clean tube with water. 230913:
  ' [GB2:KEYW] SerialHandler.TxRxFast(on.water_valve_tube)
  SerialHandler.TxRxFast({On}.water_valve_tube)
  Wait 5
finish:
  SerialHandler.TxRxFast(off.water_valve_tube)
  SerialHandler.TxRxFast(off.kaoline_valve)
  SerialHandler.TxRxFast(off.pump_tube)
  Wait 1
End

Public Sub Stop_Stir()
  'china: use serial control for stirrer:
  MainAZC.StatusText("Stop stirrer and move to clean centre...")
  Stirrer.SetRpm(0)    '
  'SerialHandler.TxRxFast(off.stirrer)
  StirProcess.MoveStir("clean")
  CleanMachine.Stir(TimeTable.Stirrer_Clean_Time)
  MainAZC.update_leds()
End

Public Sub Wait_For_Centrifuge()
  ' load timer
  Centrifuge_Done = False
  TimerCentrifuge.Delay = TimeTable.Centrifuge_Time ' 4000  ' debug
  TimerCentrifuge.Enabled = True
  ' wait until expired
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
    CleanMachine.stir_stop_check()
  Loop Until Centrifuge_Done = True
finish:
End

Public Sub Move_Output(position As String)
  If position = "capture" Then
    MainAZC.StatusText("Move output store to capture position...")
    'china: move drain away:
    ' [GB2:KEYW] SerialHandler.TxRxFast(on.drain_bowl)          'china
    SerialHandler.TxRxFast({On}.drain_bowl)          'china
    Do
      Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "on"  'china

    ' [GB2:KEYW] SerialHandler.TxRxFast(on.output_store_move)
    SerialHandler.TxRxFast({On}.output_store_move)
    Do
      Wait 0.1
    Loop Until Check.Output_Store_Move() = "on"
  Else If position = "rest" Then
    MainAZC.StatusText("Move output store away...")
    SerialHandler.TxRxFast(off.output_store_move)
    Do
      Wait 0.1
    Loop Until Check.Output_Store_Move() = "off"

    'china: move drain back under bowl:
    SerialHandler.TxRxFast(off.drain_bowl)           'china
    Do
      Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "off"  'china

  Endif
  Wait 1  ' psyco wait.
End

Public Sub Stop_Bowl()
  MainAZC.StatusText("Stop bowl...")
  SerialHandler.TxRxFast(off.freq_1)
  SerialHandler.TxRxFast(off.freq_2)
  Bowl_Stopped = False
  TimerBowlSlowDown.delay = TimeTable.Motor_DEC ' 20000 ' debug. time is equal to "DEC" parameter in freq inverters.
  TimerBowlSlowDown.Enabled = True
End

Public Sub Wait_For_Capture()
  Capture_Done = False
  TimerCapture.Delay = TimeTable.Output_Capture_Time ' 10000
  TimerCapture.Enabled = True
  MainAZC.StatusText("capturing result...")
  Do
    Wait 0.1
    CleanMachine.stir_stop_check()
  Loop Until Capture_Done = True
  MainAZC.StatusText("capturing result done.")
End

Public Sub Rotate_Output()
  Output_Container = False
  Search.Next_Output()
  If Check.Output_Container() = "present" Then Output_Container = True
End

Public Sub Stop_All()
  Print " knock all down"
  ' [GB2:KEYW] SerialHandler.TxRx(on.lamp_red)
  SerialHandler.TxRx({On}.lamp_red)
  SerialHandler.TxRx(off.lamp_green)
  SerialHandler.TxRx(off.lamp_orange)
  SyncMachine.Controls_To_Default()
  
  If Bowl_Running = True
    TimerBowlSlowDown.Enabled = False
    TimerBowlSlowDown.delay = TimeTable.Motor_DEC 'time is equal to "DEC" parameter in freq inverters.
    TimerBowlSlowDown.Enabled = True
    Bowl_Stopped = False
  Endif
  Do
     Wait 0.1
  Loop Until Bowl_Stopped = True
End

Public Sub TimerStir_Timer()
  TimerStir.Enabled = False
  Stir_Ready = True
End

Public Sub TimerBowlSpeedup_Timer()
  TimerBowlSpeedup.Enabled = False
  Bowl_On_Speed = True
End

Public Sub TimerMagn_Timer()
  TimerMagn.Enabled = False
  Magn_Done = True
End

Public Sub TimerWater_Timer()
  TimerWater.Enabled = False
  Water_Done = True
End

Public Sub TimerSample_Timer()
  TimerSample.Enabled = False
  Sample_Done = True
End

Public Sub TimerKaoline_Timer()
  TimerKaoline.Enabled = False
  Kaoline_Done = True
End

Public Sub TimerCentrifuge_Timer()
  TimerCentrifuge.Enabled = False
  Centrifuge_Done = True
End

Public Sub TimerCapture_Timer()
  TimerCapture.Enabled = False
  Capture_Done = True
End

Public Sub TimerBowlSlowDown_Timer()
  TimerBowlSlowDown.Enabled = False
  Bowl_Stopped = True
  Bowl_Running = False
End

Public Sub TimerBowlStartDelay_Timer()
  TimerBowlStartDelay.Enabled = False
  Bowl_May_Go = True
End

Public Sub STOP_TIMERS()
  TimerBowlSlowDown.Enabled = False
  TimerBowlSpeedup.Enabled = False
  TimerBowlStartDelay.Enabled = False
  TimerCapture.Enabled = False
  TimerCentrifuge.Enabled = False
  TimerKaoline.Enabled = False
  TimerMagn.Enabled = False
  TimerSample.Enabled = False
  TimerStir.Enabled = False
  TimerWater.Enabled = False
End

