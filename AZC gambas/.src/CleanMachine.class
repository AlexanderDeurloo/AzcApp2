' Gambas class file

Public Kaoline_Clean_Pending As Boolean = False
Public Bowl_Clean_Pending As Boolean = False
Public Tube_Clean_Pending As Boolean = False

Public Stir_Clean_Pending As Boolean = False
Public Stir_Clean_Setup As Boolean = False

Public Sub All(skipbowl As Boolean)
  If (Stir_Clean_Setup = True) Then ' stir cleaning is not stopped yet
  Print " stir is bezig"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Stir_Stop_Check() = "done"   ' check until stirrer clean is done.
  Endif
  Print "nu de bowl dan"
  Wait 0.5
  If skipbowl = False Then Bowl_Setup()
finish:
End


Public Sub Stir(cleanTime As Integer) ' cleantime in seconds
  Print "cleantime = " & cleanTime
  If Stir_Clean_Setup = False Then
    MainAZC.Stirrer_Dirty = True
    MainAZC.update_leds()
    Stir_Clean_Pending = True
    Stirrer_Setup(cleanTime)
    Stir_Clean_Setup = True
    Return
  Endif
  Wait 0.1
  Print "stir clean pending = " & Stir_Clean_Pending
  If (Stir_Clean_Pending = False) Then
    Stirrer_Stop()  ' close all valves
    Stir_Clean_Setup = False
    Stir_Clean_Pending = False
    MainAZC.Stirrer_Dirty = False
    MainAZC.update_leds()
    Return
  Endif
  Return
End


Public Sub Stirrer_Setup(cleanTime As Integer)
  ' check position
  ' TODO: what if the position is ERR? Can we make a function that corrects it in a safe way?
  If Check.Stirrer_Rotate() = "stir" Then
    If Check.Stirrer_Lift() = "down" Then
      PlcOutputs.StirrerLift("up") ' lift up
      Do
        FillProcess.CheckFill()
        Wait 0.1
      Loop Until Check.Stirrer_Lift() = "up"
    Endif
      PlcOutputs.StirrerRotate("clean") ' move to clean position
    Do
        FillProcess.CheckFill()
        Wait 0.1
    Loop Until Check.Stirrer_Rotate() = "clean"
  Endif
  If Check.Stirrer_Lift() = "up" Then
    PlcOutputs.StirrerLift("down") ' lift down
    Do
        FillProcess.CheckFill()
        Wait 0.1
    Loop Until Check.Stirrer_Lift() = "down"
  Endif
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
  ' stirrer is in clean position now.
  Wait 0.1
    PlcOutputs.Set("WaterValveStirrerClean", 1)
  Wait 0.1
    PlcOutputs.Set("AirTubeValveSample", 1)
  Wait 0.1
    PlcOutputs.Set("WaterValveTubes", 1)
  TimerStirClean.Enabled = False
  TimerStirClean.Delay = cleanTime 'ms
  TimerStirClean.Enabled = True
  Print "timer stir started..." & CStr(cleanTime) & "msec"
  Return
End

Public Sub TimerStirClean_Timer()
  TimerStirClean.Enabled = False
  Stir_Clean_Pending = False
  Print "stir clean TIMER END"
End


Public Sub Stirrer_Stop()
    PlcOutputs.Set("WaterValveTubes", 0)
  Wait 0.1
    PlcOutputs.Set("AirTubeValveSample", 0)
  Wait 0.1
    PlcOutputs.Set("WaterValveStirrerClean", 0)
  Wait 0.1
  Stirrer.SetRpm(0)  'use serial control for stirrer
  Wait 0.1
End

Public Sub Stir_Stop_Check() As String
  If (Stir_Clean_Pending = False) And (Stir_Clean_Setup = True) Then    ' to check is time expired + to avoid restart cleaning
    Stir(0)  ' STOPS STIR CLEANING
    Print "clean is fini"
    Return "done"
  Endif
  Return "busy"
End










Public Sub Bowl_Setup()
  MainAZC.Bowl_Dirty = True
  Bowl_Clean_Pending = True
  MainAZC.update_leds()
  Print "bowl clean"

  Print "wait for stir to complete"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until (Stir_Clean_Pending = False)
  Print "stir is ready, bowl can continue"
  Print "freq1 off"
  'Print SerialHandler.TxRxFast(off.freq_1)  ' safety
  ' TODO: freq control via RS485 !!!
  Print "freq 2 off"
  'Print SerialHandler.TxRxFast(off.freq_2)  ' safety
  ' TODO: freq control via RS485 !!!
  Print "wait until bowl stopped(simple timer)"
  Do
    Wait 0.1
    Print ","
  Loop Until ProcessCTRL.Bowl_Stopped = True  ' wait for bowl to stop. This way we make sure that the tiny motor can be attached.
  
  Print "make output store position is off"
  If Check.Output_Store_Move() = "on" Then
    PlcOutputs.OutputStoreMove("rest")
    'SerialHandler.TxRxFast(off.output_store_move)
    Do
     Wait 0.1
    Loop Until Check.Output_Store_Move() = "off"
  Endif

  Print "make drain_bowl position under bowl"  'china: move it under bowl
  If Check.Drain_Bowl_Position() = "on" Then
    PlcOutputs.BowlDrain("underbowl")
    'SerialHandler.TxRxFast(off.drain_bowl)
    Do
     Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "off"
  Endif

  ' wait for stir clean.
  Print "bowl ls"
  ' bowl slow speed
  If MainAZC.StopProcess = 1 Then Goto finish
  ' TODO: freq control via RS485 for slow speed
  'Print SerialHandler.TxRxFast({On}.bowl_low_speed)
  Wait 0.5
  ' kaoline clean moment
  Print "clean kaoline tube"
  PlcOutputs.Set("AirTubeValveKaoline", 1)
  Kaoline_Clean_Pending = True
  TimerKaolineClean.Delay = TimeTable.Kaoline_Valve_Clean_Time
  TimerKaolineClean.Enabled = True
  PlcOutputs.Set("WaterValveTubes", 1)      ' push kaoline back with clean water
  Do
    Wait 0.001
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Kaoline_Clean_Pending = False    ' wait for kaoline time.
  Wait 0.1
  PlcOutputs.Set("WaterValveTubes", 0)
  Wait 0.1
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  Wait 1
  Print " do the bowl clean procedure"
  Tube_Clean_Pending = True
  PlcOutputs.Set("WaterValveTubes", 1)
  PlcOutputs.Set("TubePumpPower", 1)
  TimerCleanTube.Delay = TimeTable.Tube_Clean
  TimerCleanTube.Enabled = True
  Do
    Wait 0.01
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Tube_Clean_Pending = False
  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.Set("TubePumpPower", 0)

  Wait 0.5
  PlcOutputs.Set("WaterValveHpPump", 1)
  Wait 1
  PlcOutputs.Set("HpPumpPower", 1)
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase1_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase1 started..." & CStr(TimeTable.Bowl_Clean_Phase1_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  PlcOutputs.Set("HpPumpPower", 0)
  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase2_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase2 started..." & CStr(TimeTable.Bowl_Clean_Phase2_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  
  PlcOutputs.Set("WaterValveHpPump", 1)
  PlcOutputs.Set("HpPumpPower", 1)
  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase3_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase3 started..." & CStr(TimeTable.Bowl_Clean_Phase3_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
   
  Bowl_Stop()
  MainAZC.Bowl_Dirty = False
  MainAZC.update_leds()
finish:
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.Set("TubePumpPower", 0)
  PlcOutputs.Set("HpPumpPower", 0)
  Return
End




Public Sub Bowl_Stop()
  PlcOutputs.Set("HpPumpPower", 0)
  Wait 0.2
  ' TODO: freq control via RS485 !!!!!
  'SerialHandler.TxRxFast(off.bowl_low_speed)
  Print "bowl is clean and all related ctrls are off"
  Return
End

Public Sub TimerKaolineClean_Timer()
  TimerKaolineClean.Enabled = False
  Print "kaoline tube clean time expired"
  Kaoline_Clean_Pending = False
  Return
End

Public Sub TimerBowlClean_Timer()
  TimerBowlClean.Enabled = False
  Print "bowl clean timer expired"
  Bowl_Clean_Pending = False
End


Public Sub TimerCleanTube_Timer()
  TimerCleanTube.Enabled = False
  Tube_Clean_Pending = False
End

Public Sub STOP_TIMERS()
  TimerBowlClean.Enabled = False
  TimerCleanTube.Enabled = False
  TimerKaolineClean.Enabled = False
  TimerStirClean.Enabled = False
End

