' Gambas class file

Public Kaoline_Clean_Pending As Boolean = False
Public Bowl_Clean_Pending As Boolean = False
Public Tube_Clean_Pending As Boolean = False

Public Stir_Clean_Pending As Boolean = False
Public Stir_Clean_Setup As Boolean = False

Public StirrerDry As Boolean = False
Public StirSpinDryDone As Boolean = False
Public StirSpinning As Boolean = - False
Public StirSpinTimerPending As Boolean = False


Public Sub Magnesium(Duration As Integer)
  If Duration < 2 Then Duration = 2
  
  PlcOutputs.Set("AirTubeValveMagnesium", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Magnesium() = "on"
  PlcOutputs.Set("WaterValveTubes", 1)
     Wait Duration
  PlcOutputs.Set("WaterValveTubes", 0)
  Wait 0.2
  PlcOutputs.Set("AirTubeValveMagnesium", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Magnesium() = "off"
End


Public Sub All(skipbowl As Boolean)
  If (Stir_Clean_Setup = True) Then ' stir cleaning is not stopped yet
  Print " stir is bezig"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Stir_Stop_Check() = "done"   ' check until Stirrer clean is done.
  Endif
  If skipbowl = False
    Print "nu de bowl dan"
    Bowl_Setup()
  Endif
finish:
End


Public Sub StirSpinInit()
  StirSpinning = False
  StirSpinTimerPending = False
  StirSpinDryDone = False
End


Public Sub StirSpinDry()
  If StirrerDry = True Then Return
  If StirSpinDryDone = True Then Return

  If StirSpinning = True
    If StirSpinTimerPending = True Then Return
    Stirrer.SetRpm(0)
    StirSpinDryDone = True
    StirrerDry = True
    Return
  Endif
  StirSpinDryDone = False
  StirSpinning = True
  StirProcess.MoveStir("clean")
  Stirrer.SetRpm(2100)
  TimerStirClean.Enabled = False
  TimerStirClean.Delay = 15000 'ms
  StirSpinTimerPending = True
  TimerStirClean.Enabled = True
End




Public Sub Stir(cleanTime As Integer) ' cleantime in seconds
  Print "cleantime = " & cleanTime
  If Stir_Clean_Setup = False Then
    MainAZC.Stirrer_Dirty = True
    MainAZC.update_leds()
    Stir_Clean_Pending = True
    Stirrer_Setup(cleanTime)
    Stir_Clean_Setup = True
    Return
  Endif
  Wait 0.1
  Print "stir clean pending = " & Stir_Clean_Pending
  If (Stir_Clean_Pending = False) Then
    Stirrer_Stop()  ' close all valves
    Stir_Clean_Setup = False
    Stir_Clean_Pending = False
    MainAZC.Stirrer_Dirty = False
    MainAZC.update_leds()
    StirrerDry = False
    Return
  Endif
  Return
End


Public Sub Stirrer_Setup(cleanTime As Integer)
  ' check position
  ' TODO: what if the position is ERR? Can we make a function that corrects it in a safe way?
  If Check.Stirrer_Rotate() = "stir" Then
    If Check.Stirrer_Lift() = "down" Then
      PlcOutputs.StirrerLift("up") ' lift up
      Do
        FillProcess.CheckFill()
        Wait 0.1
      Loop Until Check.Stirrer_Lift() = "up"
    Endif
      PlcOutputs.StirrerRotate("clean") ' move to clean position
    Do
        FillProcess.CheckFill()
        Wait 0.1
    Loop Until Check.Stirrer_Rotate() = "clean"
  Endif
  If Check.Stirrer_Lift() = "up" Then
    PlcOutputs.StirrerLift("down") ' lift down
    Do
        FillProcess.CheckFill()
        Wait 0.1
    Loop Until Check.Stirrer_Lift() = "down"
  Endif
  Stirrer.SetRpm(Val(MainAZC.Var_Array[MainAZC.Stirrer_Low_Speed, MainAZC.Var_Ini]))    '
  ' Stirrer is in clean position now.
  Wait 0.5
    PlcOutputs.Set("WaterValveStirrerClean", 1)
  Wait 0.5

    PlcOutputs.Set("AirTubeValveSample", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Sample() = "on"
  Wait 0.2
    PlcOutputs.Set("WaterValveTubes", 1)
  TimerStirClean.Enabled = False
  TimerStirClean.Delay = cleanTime 'ms
  TimerStirClean.Enabled = True
  Print "timer stir started..." & CStr(cleanTime) & "msec"
  Return
End

Public Sub TimerStirClean_Timer()
  TimerStirClean.Enabled = False
  Stir_Clean_Pending = False
  StirSpinTimerPending = False
  Print "stir clean TIMER END"
End


Public Sub Stirrer_Stop()
    PlcOutputs.Set("WaterValveTubes", 0)
  Wait 0.5
    PlcOutputs.Set("AirTubeValveSample", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Sample() = "off"
  Wait 0.2
    PlcOutputs.Set("WaterValveStirrerClean", 0)
  Wait 0.5
  Stirrer.SetRpm(0)  'use serial control for stirrer
  Wait 0.1
End

Public Sub Stir_Stop_Check() As String
  If (Stir_Clean_Pending = False) And (Stir_Clean_Setup = True) Then    ' to check if time expired + to avoid restart cleaning
    Stir(0)  ' STOPS STIR CLEANING
    Print "stir clean is fini"
    Return "done"
  Endif
  Return "busy"
End










Public Sub Bowl_Setup()
  MainAZC.Bowl_Dirty = True
  Bowl_Clean_Pending = True
  MainAZC.update_leds()
  Print "bowl clean"

  Print "wait for stir to complete"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until (Stir_Clean_Pending = False)
  Print "stir is ready, bowl can continue"
  FreqCtrl.SetFreq(0.0, "OFF")
  ' TODO: read freq controller via RS485 for actual status
  Print "wait until bowl stopped(simple timer)"
  Do
    Wait 0.1
    Print ","
  Loop Until ProcessCTRL.Bowl_Stopped = True  ' wait for bowl to stop. This way we make sure that the tiny motor can be attached.
  
  Print "make output store position is in rest"
  If Check.Output_Store_Move() = "off" Then
    PlcOutputs.OutputStoreMove("rest")
    Do
     Wait 0.1
    Loop Until Check.Output_Store_Move() = "on"
  Endif

  Print "move drain under bowl" 
  If Check.Drain_Bowl_Position() = "off" Then
    PlcOutputs.BowlDrain("underbowl")
    Do
     Wait 0.1
    Loop Until Check.Drain_Bowl_Position() = "on"
  Endif

  ' wait for stir clean.
  Print "bowl lowspeed"
  If MainAZC.StopProcess = 1 Then Goto finish
  FreqCtrl.SetFreq(2.0, "ON")
  ' TODO: read freq controller via RS485 for actual status
  Wait 0.5
  ' kaoline clean moment
  Print "clean kaoline tube"
  PlcOutputs.Set("AirTubeValveKaoline", 1)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "on"
  Kaoline_Clean_Pending = True
  TimerKaolineClean.Delay = TimeTable.Kaoline_Valve_Clean_Time
  TimerKaolineClean.Enabled = True
  PlcOutputs.Set("WaterValveTubes", 1)      ' push kaoline back with clean water
  Do
    Wait 0.001
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Kaoline_Clean_Pending = False    ' wait for kaoline time.
  Wait 0.1
  PlcOutputs.Set("WaterValveTubes", 0)
  Wait 0.1
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "off"
  Wait 0.5
  Print " do the bowl clean procedure"
  Tube_Clean_Pending = True
  PlcOutputs.Set("WaterValveTubes", 1)
  PlcOutputs.TubePump("on")
  TimerCleanTube.Delay = TimeTable.Tube_Clean
  TimerCleanTube.Enabled = True
  Do
    Wait 0.01
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Tube_Clean_Pending = False
  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.TubePump("off")

  FreqCtrl.SetFreq(0.5, "ON")
  Wait 0.5
  PlcOutputs.Set("WaterValveHpPump", 1)
  Wait 1


  
  PlcOutputs.Set("HpPumpPower", 1)
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase1_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase1 started..." & CStr(TimeTable.Bowl_Clean_Phase1_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  PlcOutputs.Set("HpPumpPower", 0)


  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Pause_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl pause started..." & CStr(TimeTable.Bowl_Clean_Pause_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False

  
  PlcOutputs.Set("HpPumpPower", 1)
  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase2_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase2 started..." & CStr(TimeTable.Bowl_Clean_Phase2_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  PlcOutputs.Set("HpPumpPower", 0)
  

  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Pause_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl pause started..." & CStr(TimeTable.Bowl_Clean_Pause_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False


  PlcOutputs.Set("HpPumpPower", 1)
  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase3_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase3 started..." & CStr(TimeTable.Bowl_Clean_Phase3_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  PlcOutputs.Set("HpPumpPower", 0)


  PlcOutputs.Set("BowlCleanLowPressure", 1)
  Bowl_Clean_Pending = True
  TimerBowlClean.Delay = TimeTable.Bowl_Clean_Phase3_Time 'ms
  TimerBowlClean.Enabled = True
  Print "timer bowl phase3 started for low pressure..." & CStr(TimeTable.Bowl_Clean_Phase3_Time) & "msec"
  Do
    Wait 0.1
    If MainAZC.StopProcess = 1 Then Goto finish
  Loop Until Bowl_Clean_Pending = False
  PlcOutputs.Set("BowlCleanLowPressure", 0)

  'Wait 2
  'FreqCtrl.SetFreq(75, "ON")
  'Wait TimeTable.Motor_ACC / 1000  ' TODO: make more intelligent with timer and abort option.
  Bowl_Stop()
  'Wait TimeTable.Motor_DEC / 1000  ' TODO: make more intelligent with timer and abort option.


  MainAZC.Bowl_Dirty = False
  MainAZC.update_leds()
finish:
  Print "Bowl clean finished"
  PlcOutputs.Set("AirTubeValveKaoline", 0)
  Do
	   Wait 0.2
  Loop Until Check.TubeValve_Kaoline() = "off"
  PlcOutputs.Set("WaterValveTubes", 0)
  PlcOutputs.TubePump("off")
  PlcOutputs.Set("HpPumpPower", 0)
  PlcOutputs.Set("BowlCleanLowPressure", 0)
  Return
End




Public Sub Bowl_Stop()
  PlcOutputs.Set("HpPumpPower", 0)
  Wait 0.2
  FreqCtrl.SetFreq(0.0, "OFF")
  ' TODO: read freq controller via RS485 for actual status
  Print "bowl is clean and all related ctrls are off"
  Return
End

Public Sub TimerKaolineClean_Timer()
  TimerKaolineClean.Enabled = False
  Print "kaoline tube clean time expired"
  Kaoline_Clean_Pending = False
  Return
End

Public Sub TimerBowlClean_Timer()
  TimerBowlClean.Enabled = False
  Print "bowl clean timer expired"
  Bowl_Clean_Pending = False
End


Public Sub TimerCleanTube_Timer()
  TimerCleanTube.Enabled = False
  Tube_Clean_Pending = False
End

Public Sub STOP_TIMERS()
  TimerBowlClean.Enabled = False
  TimerCleanTube.Enabled = False
  TimerKaolineClean.Enabled = False
  TimerStirClean.Enabled = False
End

