' Gambas class file

Library "/home/pi/AzcApp/libSerial"
Extern SerialTxRx(Devicename As String, DataTx As String, Reply As Pointer, Length As Integer, Blocking As Integer) As Integer
Extern SerialOpen(Devicename As String, Speed As Integer, Parity As Integer, Blocking As Integer, Reset As Integer) As Integer
Extern SerialClose()


Public SerialPortCpu As String = ""

Public Sub Init(SerialDevice As String) As Integer
    If (SerialDevice == Null) 
      Print "Serial name for cpu comm is invalid"
      Return 1
    Endif
    Print "Serial name for cpu comm is " & SerialDevice
    SerialPortCpu = SerialDevice
    Return 0
End


Public Sub TxRxFast(Command As String, Blocking As Integer) As String
  Dim CommandToSend As String
  Dim ReplyFromCpu As String = "123456789012345678901234567890"
  Dim bytecnt As Integer
  If (SerialPortCpu == "")
    Print "Error in TxRxFast: no serial port defined\n";
    Return
  Endif
  
  CommandToSend = Command
  If (InStr(Command, "\n") == 0)
    CommandToSend = CommandToSend & "\n"
  Endif
    
  bytecnt = SerialTxRx(SerialPortCpu, CommandToSend, VarPtr(ReplyFromCpu), 30, Blocking)
  If (bytecnt > 1)
    ReplyFromCpu = Left$(ReplyFromCpu, bytecnt - 1)
  Endif
  Return ReplyFromCpu
  
End

Public Sub Reset(SerialDevice As String)  ' TODO: needs fine tuning: time and colors, etc. below works, but is Q%
  Dim ReplyFromCpu As String
  ReplyFromCpu = TxRxFast("blinkon", 1)
  Wait 2
  SerialOpen(SerialDevice, 4800, 1, 0, 1) ' reset On means: dtr Line set And cleared
  Wait 5
  SerialClose()
  Wait 1
  TxRxFast("red", 0)
  Wait 3
  
  ReplyFromCpu = TxRxFast("blue", 1)
  Print "After reset and red we received " & ReplyFromCpu
  Wait 0.5
  ReplyFromCpu = TxRxFast("blinkon", 1)
  Print "after blinkon we received " & ReplyFromCpu
  
End
